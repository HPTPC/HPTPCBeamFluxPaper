\section{Beam Line and Detectors}
\label{hptpcPaper:sec:Methods}

    \subsection{Beam Test Overview}
    The beam test took place in the T10 beam line, East Area at the Proton Synchrotron in CERN from the 15th August to the 18th September 2018.
    The results in this paper use data taken on the 31st August and 1st September, during which the setup configuration was varied as described below.
    The primary components of the  experimental setup for the data taking period is shown in Figure~\ref{fig:setup}.
    \begin{figure}
    \includegraphics[width=1.0\linewidth]{files/Figures/T10Diagram.jpg}
    	\caption{Beam test configuration}
    		\label{fig:setup}
    \end{figure}
    The centre of the HPTPC Prototype was placed 13~m from the wire chamber, labeled as $WC$, at the beam entrance. Three ToF constituents, labeled $S1$ to $S3$, were placed upstream of the TPC, while the fourth, labeled $S4$, was placed directly downstream. Both the TPC and ToF systems were placed at an off-axis angle with respect to the direction of the beam.
    Additionally, a variable number of blocks of acrylic moderator, shown in Figure~\ref{fig:modblocks}, were placed in the beamline, immediately behind of $S1$.
    
    
    Data acquisition (DAQ) of up- and downstream ToF systems were completely independent. Due to low intensity of the beam, the synchronization between systems was done offline using the reference signal from PS at the beginning of every spill. The trigger condition of the upstream ToF was based on the coincidence between $S1$ and $S3$ constituents. While DAQ of the downstream ToF, $S4$, was run in self-triggering mode with a gate open during the spill. Coincidence signals between $S1$ and $S2$ counters was also recorded by the DAQ of the downstream ToF and was used in the particle identification (PID) analysis. 
    
    
    A system of moderator blocks was located between $S1$ and $S2$ counters.  The system is composed of a stand on which up to four polystyrene $10\times10\times10$~cm$^3$ blocks can be placed. Figure~\ref{fig:modblocks} shows the stand with four blocks on it. The moderator blocks have the effect of both reducing the energy of incoming particles as well as scattering protons at higher angles than minimum ionizing particles (MIP), thus increasing the proton to MIP ratio at off-axis angles from the beam. 
    
    Data was taken with the beam momentum primarily at 0.8~GeV/c, and with each configuration of 0 to 4 moderator blocks. Figure~INSERT shows the typical composition of the beam upstream of $S1$ at 0.8~GeV/c. Beam spills are approximately 500~ms in length with 5-10~s between spills.  
    
%    Moderator blocks were used in order to cause a spread in the incoming beam.
%    The blocks cause protons to scatter through a larger angle than pions and other minimum ionising particles (MIP), increasing the off-axis proton pion ratio.
%    The effect of this, together with placing the TPC and ToF systems off axis was to allow a measurement of protons with a lower pion background.
%    This technique also had the effect of reducing the average momentum of the measured particles.
%    Data were taken for 0, 1, 2, 3, and 4 moderator blocks in turn.
%    The beam ran with an energy of 0.8~GeV/c, and primarily comprised protons and pions, as well as muons and electrons. 
%    Beam spills were approximately 500~ms in length, with 5-10~s between spills.
%    The ratio of protons to pions expected in the T10 beam  is shown in figure~\ref{beamcharacteristics}.
%    From this figure, the expected on axis proton pion ratio at 0.8~GeV/c is approximately 1:6.
%      \begin{figure}
%      \centering
%    \includegraphics[width=0.6\linewidth]{files/Figures/offaxismeasurement.png}
%    	\caption{T10 beam constituents (REFERENCE NEEDED)}
%    		\label{fig:beamcharacteristics}
%    \end{figure}
    
    
    \begin{figure}[t]
      \centering
    %\includegraphics[width=0.2\linewidth]{files/Figures/ModeratorBlocks.jpg}
    \includegraphics[width=1.05\linewidth]{files/Figures/S1S2S3S4.png}
    	\caption{Photo demonstrating the $S1$ and $S2$ counters and the stand with four acrylic moderator blocks of the upstream part of the setup (right). Photo of the downstream part of the setup which shows the $S3$, $S4$ detectors and HPTPC (left).}
    		\label{fig:modblocks}
    \end{figure}
    
    
	\subsection{Upstream beam counters $S1$ and $S2$}
	
	The beam counters $S1$ and $S2$ are shown in Figure~\ref{fig:modblocks}. The $S1$ counter is a $40\times40\times5$~mm$^3$ plastic scintillator tile which is attached to four 1'' Hamamatsu R4998 phototubes from four ends for the light readout. The time resolution of the counter, as measured by the DAQ system of the upstream ToF, was about 30~ps. 
	
	The counter $S2$ was placed 1.4~m (TBC) downstream of $S1$. The size of the scintillator tile, $120\times120\times5$~mm$^3$, and its position were adjusted to account for the beam divergence in the moderator blocks. The light was collected by a 2'' PMT R13089 which was connected to the scintillator via long light-guide as shown in Figure~\ref{fig:modblocks}. 
	
	The analog signals from one of the $S1$ PMTs and $S2$ PMT were fed into NIM discriminator units.
	%set at AA mV and BB mV respectively. 
	As a next step, the discriminated signals were fed into a NIM coincidence unit, and the coincidence of the two signals was recorded by the DAQ systems of $S3$ and $S4$. This information was further used for the time-of-flight analysis of the downstream ToF. 

    
\subsection{Upstream Time of Flight instrumentation ($S3$)}

The $S3$ `upstream' ToF constituent sits just upstream of the HPTPC prototype in the beamline. The sketch of the $S3$ ToF constituent is shown in Figure~\ref{fig:S3sketch}. The detector is composed of 22 staggered bars:  20 bars with dimensions $1.68 \times 6 \times 1$~cm$^3$ and 2 bars of  $1.5 \times 6 \times 1$~cm$^3$ placed on top and bottom \cite{S3-proceedings}.
The overlap between bars was set to 5~mm, thus the active area of the detector was approximately 1.68~m $\times$ 1.22~m.
     \begin{figure}
      \centering
    \includegraphics[width=0.7\linewidth]{files/Figures/uToF_sketch.pdf}
    	\caption{Sketch of the $S3$ wall \cite{S3-proceedings}.}
    		\label{fig:S3sketch}
    \end{figure}
    
The bars are made from the plastic EJ-200 \cite{SCIONIX}, which 
provides a suitable optical attenuation length 4~m and fast timing (rise time of 0.9~ns and decay time 2.1~ns). 
The scintillation emission spectrum of EJ-200 resides primarily in the violet region of the visible spectrum that well corresponds to the maximum absorption region of photosensors used for the readout.

Arrays of eight $6 \times 6$~mm$^2$ area silicone photomultipliers (SiPMs) S13360-6050PE from Hamamatsu Photonics \cite{Hamamatsu} were coupled to both ends of the bar to collect scintillation photons. Anode signals of SiPMs have been read out, summed and shaped by a dedicated circuit as described in Ref.\,\cite{S3-readout}.
%an 8-channel SiPM anode readout integrated circuit MUSIC-R1. %The construction of the prototype was a joint effort between groups of Geneva and Zurich universities as a part of R\&D for the Timing detector of the SHIP experiment \cite{AK}.

A 64-ch SAMPIC  module was used for the data acquisition. A SAMPIC chip is a Waveform and Time to Digital Converter (WTDC) 16-channel ASIC which provides a raw time with an ultrafast analog memory allowing fine timing extraction as well as other parameters of the pulse~\cite{SAMPIC}. Each channel integrates a discriminator that can trigger itself independently or participate to a more complex trigger. 
Three ASICs ($16\times3=48$ channels) of the module were connected to 44 channels of $S3$ and were run in self-triggering mode. The 4th ASIC was used to acquire data from $S1$, coincidence signal $S1\cap S2$ and the start-of-spill signal from PS. A second level trigger was implemented in firmware and run on a level of ASICs. 
Namely, the data were sent to the hard disk of the DAQ notebook only in the case of coincidence between $S1$ channels and channels of three ASICs used for $S3$.


A mean time of light signals detected at two ends of a single bar provides a time reference with the resolution of about 100~ps, while the difference between the time of the light signals gives the position of the interaction along the bar, with a resolution of 1.6~cm. Examples of reconstructed $XY$ distributions are shown in Figures~\ref{fig:s3XY_pion} and~\ref{fig:s3XY_proton}.



\begin{figure}[t]
	\begin{minipage}[t]{0.49\textwidth}
		\centering
		\begin{adjustbox}{max totalsize={\textwidth}{.5\textheight},center}
			\input{files/Figures/0_pionXY.tex}
		\end{adjustbox}
		\caption{Reconstructed $XY$ distribution of hits observed in $S3$. In this case a timing cut has been applied to select only those hits identified as coming from minimum ionizing particles. This particular data was taken without a moderator in the beamline.}
		\label{fig:s3XY_pion}
	\end{minipage} 	
	\hfill
	\begin{minipage}[t]{0.49\textwidth}
		\centering
		\begin{adjustbox}{max totalsize={\textwidth}{.5\textheight},center}
			\input{files/Figures/4_protonXY.tex}
		\end{adjustbox}
		\caption{Reconstructed $XY$ distribution of hits observed in $S3$. In this case a timing cut and an amplitude cut has been applied to select only those hits thought to come from protons. This data was taken with 4 moderator blocks in the beamline.}
		\label{fig:s3XY_proton}
	\end{minipage}
\end{figure}
  
    

%    The placement of each of the four time of flight constituents in respect to the TPC is shown in figure~\ref{fig:S1S2S3S4}.
%    \begin{figure}
%      \centering
%%    \includegraphics[width=0.6\linewidth]{files/Figures/S1S2S3S4.png}
 %   	\caption{Position of the time of flight constituents in the T10 beam hall. The TPC prototype and beam entrance are also shown}
 %   		\label{fig:S1S2S3S4}
 %   \end{figure}
    



\subsection{Downstream Time of Flight instrumentation ($S4$)}
	
The $S4$ `downstream' ToF constituent sits just downstream of the HPTPC prototype in the beamline. It consists of 10 bars of Nuvia plastic scintillator \cite{NUVIA}. Attached to either end of each of these scintillator bars is a 5" Hamamatsu R6594 photomultiplier tube. The bars are arranged in two rows of five, such that there is complete coverage for any beam particles incident upon the detector. Diagrams of the $S4$ wall, along with its dimensions are presented in Figure~\ref{fig:dstofFront} and~\ref{fig:dstofDiagonal}. The time resolution of the bars and PMTs was measured to be 1~ns. The corresponding spatial resolution of the bars and PMTs was measured to be 8.3~cm.
    
    \begin{figure}[ht]    
    	\begin{minipage}[t]{.48\textwidth}
    		\centering
    		\includegraphics[width=0.6\linewidth]{files/Figures/dstofFront.png}
    		\caption{Front view of the downstream time of flight system}
    		\label{fig:dstofFront}
    	\end{minipage}
    	\hspace{0.3cm}
    	\begin{minipage}[t]{.48\textwidth}
    		\centering
    		\includegraphics[width=0.45\linewidth]{files/Figures/dstofDiag.png}
    		\caption{Diagonal view of the downstream time of flight system showing more clearly the two rows of scintillator bars and photomultiplier tubes}
    		\label{fig:dstofDiagonal}
    	\end{minipage}
    \end{figure}
    
All 20 of the PMTs have their anode signals read out using NIM discriminators which are then fed into a time-to-digital converter. A signal in $S4$ was considered to have occurred if a signal was seen in both PMTs on the same bar within 20~ns of each other. 

Additionally, a signal was also fed into the same time-to-digital converter whenever there was a coincidence between the $S1$ and $S2$ timing points. When calculating the time of flight of a given particle, this time of coincidence was used as first timing point.

\subsection{The HPTPC Prototype}
The prototype was built at Royal Holloway, University London.  The steel vessel was rated to 6~barA of pressure, and the walls of the vessel were 4~cm thick (THIS NEEDS CHECKING).
The TPC comprised thin steel mesh electrodes (one cathode and three anodes), and 12 copper rings to create the uniform drift field. The drift distance produced was 48~cm, with the anodes separated by 1~mm. Data taking with the TPC made use of both optical and charge readout.The vessel, electrodes, and drift region of the TPC are shown in figure~\ref{fig:TPC}.
    
     \begin{figure}
      \centering
    \includegraphics[width=0.6\linewidth]{files/Figures/IMG_1194.jpg}
    	\caption{Cross-sectional view of the TPC; the thin mesh electrodes and copper ring drift volume can be seen inside the steel vessel}
    		\label{fig:TPC}
    \end{figure}
    
The centre of the TPC was placed 13~m from the beam entrance with $S3$ and $S4$ directly upstream and downstream of the vessel, respectively. Throughout the run, the TPC was filled with either pure Argon, or a combination of Argon and a small percentage of quencher.


%\subsection{Beam Taking Periods}

%The data taken for the following studies was accrued over the course 
%WHAT DATA AND WHEN (Maybe this goes earlier)
 %(this is described above now)   
\section{Analysis}
\subsection{Analysis Goals}
The primary aims of the use of $S1 - S4$ were to make measurements of the flux of particles entering and exiting the TPC vessel, and to perform particle identification using the time of flight measurement.
Using this data, it is possible to provide a momentum spectrum of particles in- and outgoing from the TPC, and calculate the ratio of particle species in the beam.

Protons take longer to travel the distance from $S1$ to $S3$ or $S4$ than lighter particles that are close to minimum ionising of the same momentum. This difference in time of flight can be used to distinguish between the two types of particles.
Distinguishing these MIPs from one another is more difficult due to similar masses and can be only determined by the upstream ToF system.
From the particle flux data, it is possible to measure the ratio of protons to other particles over the range of off-axis angles covered by the $S3$ and $S4$ walls, and for varying numbers of moderator blocks.

The variation of momentum spectrum and proton-MIP ratio with differing numbers of acrylic blocks off the beam axis provide the motivation for the measurement techniques used.
As such the data used in these results cover two days in the run where the number of moderator blocks was varied with other beam properties held constant.
The numbers of spills per moderator block configuration were as follows (with more data taken for 4 blocks as that was the configuration used for the majority of the beam test):
0 blocks: 257 spills, 1 block:  254 spills, 2 blocks: 267 spills, 3 blocks: 220 spills, 4 blocks: 3884 spills.


\subsection{Analysis Methods}

	Figure~\ref{fig:s4tof} shows the variation in the time of flight spectrum as recorded by $S4$ with a changing number of moderator blocks.
	This spectrum is given by the difference in time between observation of a coincidence in the $S1$ and $S2$ timing points and a signal being recorded in $S4$ (the definition of an $S4$ signal is given above).
	
	\begin{figure}[h]
		\begin{adjustbox}{max totalsize={.8\textwidth}{.5\textheight},center}
			\input{files/Figures/s4BkgSub_axisAdj.tex}
		\end{adjustbox}
		\caption{$S4$ time-of-flight spectra for varying numbers of moderator blocks. For all configurations, an exponentially falling background has been fitted and subtracted from the data. Additionally, the plot has also been corrected for the differing efficiencies of the various bars.}
		\label{fig:s4tof}	
	\end{figure}

	Two corrections are applied to this measurement to give fig.~\ref{fig:s4tof}. 
	The data is corrected for the efficiency of each of the $S4$ bars and a background is subtracted from the data.
	Initially, timing delays caused by cabling and equipment are taken into account.
	Then a Gaussian is fitted to the peak caused by faster particles.
	All times are normalised such that the mean of this peak is at a value of $S4 - S1$ corresponding to a particle traversing the distance between $S1$ and $S4$ at the speed of light. 
	The other times are then shifted by the same amount.
	
	Additionally, the measurements are corrected for the efficiency of each bar. 
	The efficiency of a bar is calculated by dividing the number of signal hits in coincidence with an $S1-S2$ signal in each bar by the total number of PMT hits in each bar (themselves in coincidence with an $S1-S2$ signal). 
	If the number of single PMT hits which are in coincidence with $S1-S2$ signal is expressed as $N_{1PMTcoins}$ and the number of 2 PMT signals in coincidence with an $S1-S2$ signal is expressed as $N_{2PMTcoins}$, then the efficiency is given by~(\ref{eq:barEff}).
	
	\begin{equation}
		\epsilon = \frac{N_{2PMTcoins}}{N_{2PMTcoins}+N_{1PMTcoins}}
		\label{eq:barEff}
	\end{equation}
	
	Using fig.~\ref{fig:s4tof}, protons and MIPs are selected with timing cuts. 
	These timing cuts are chosen by fitting a sum of signal and background functions to the time of flight spectra shown in figure~\ref{fig:s4tof}. 
	The signal functions are taken to be Gaussians while the background is taken to be an exponential function. 
	An example of this is shown in figure~\ref{fig:fitEx}.
	The particles in the quicker timing window (those for which $t_{S4}-t_{S1}<55~\text{ns}$ and $t_{S4}-t_{S1}>40~\text{ns}$) are considered to be minimum ionizing particles while those in the slower timing window (those for which $t_{S4}-t_{S1}<105~\text{ns}$ and $t_{S4}-t_{S1}>66~\text{ns}$) are considered to be protons.
	
	\begin{figure}[h]
		\begin{adjustbox}{max totalsize={.7\textwidth}{.62\textheight},center}
			\input{files/Figures/1_dtof1d.tex}
		\end{adjustbox}
		\caption{Example of the time of flight spectrum observed in $S4$ with a combined signal and background function fitted (shown in black)}
		\label{fig:fitEx}
	\end{figure}

	To produce the data used in this analysis, an exponential background function is subtracted. 
	The parameters for this function are taken from the combined signal and background function.

	Figure~\ref{fig:s3tof} shows the time of flight spectrum recorded in the $S3$ timing point for varying numbers of moderator blocks.
	Similarly to figure~\ref{fig:s4tof}, the quicker peak is formed by minimum ionizing particles, while the peak at higher values of $S3 - S1$ corresponds to protons.
	\begin{figure}[h]
		\begin{adjustbox}{max totalsize={.8\textwidth}{.5\textheight},center}
			\input{files/Figures/utof1dS1Log_axAdj.tex}
		\end{adjustbox}
		\caption{$S3$ time of flight spectra for varying numbers of moderator blocks.}
		\label{fig:s3tof}
	\end{figure}


    The mass distribution calculated for the data set without moderator blocks is shown in Figure~\ref{fig:s3tof_mass}. The time difference between $S3$ and $S1$ counters corresponding to a single particle was converted to the mass using the formula
    \begin{equation} 
     m^2 = p^2 \left( 
     \left(\frac{t_{S3}-t_{S1}}{x_{S3}-x_{S1}} \cdot c \right)^2
    - 1  \right)
    \end{equation}
    where the particle momentum $p$ is assumed to be 0.8~GeV/c, the distance between two detectors $x_{S3}-x_{S1}$ is 10.9~m and $c$ is the speed of light. 
    The true mass positions in Figure~\ref{fig:s3tof_mass} are indicated by vertical arrows. One can clearly observe distinct peaks corresponding to protons and deuterons. 
    The insert in the figure shows a zoomed region corresponding to the MIP particles. 
    

    \begin{figure}[h]
    \centering
    \includegraphics[width=0.9\linewidth]{files/Figures/Data_2018_8_31_b2_800MeV_0block_All.pdf}
		\caption{Reconstructed mass spectrum for the data taken without moderator blocks. The spectrum was calculated using the time difference between $S3$ and $S1$. Vertical arrows show predicted position of particles.}
		\label{fig:s3tof_mass}
	\end{figure}



    For the data collected in $S3$, both timing and signal amplitude cuts were used to select protons and MIPs.
	Figure~\ref{fig:TvsA} shows an example of the signal size recorded in one of the SiPMs on one of the scintillator bars against the measured value of $S3 - S1$.
	To reduce the number of background events in the proton sample, a minimum signal amplitude is required.
	This cut varied, depending on the SiPM in question and was determined from distributions such as those in figure~\ref{fig:TvsA}. 
	The cut values used ranged between 0.125~V and 0.3~V.
	The higher mass of the protons means that, at the beam energies used, they typically deposit more energy in the detector, resulting in greater amplitudes being observed.
	
	\begin{figure}[h]
		\begin{adjustbox}{max totalsize={.7\textwidth}, center}
			\input{files/Figures/TvsA.tex}
		\end{adjustbox}
		\caption{Example of SiPM signal amplitude plotted against uncorrected $S3$ time of flight. The population in the upper right is thought to be produced by protons.}
		\label{fig:TvsA}
	\end{figure}
	